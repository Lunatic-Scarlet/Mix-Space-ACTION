name: Builder V1.1

on: [push]
jobs:
    build-server:
        name: Build Mix-Space(server)
        runs-on: ubuntu-latest
        steps:
        - name: checkout
          uses: actions/checkout@v2
        - name: Setup Node.js environment
          uses: actions/setup-node@v2.1.4
        - name: Build server
          run: |
            git clone https://github.com/mx-space/server
            sudo npm install rimraf -g
            cd server
            sudo yarn
            sudo rm -rf .env
            sudo mv ../server_config/.env .env
            echo "成功填入用户文件"
            sudo yarn build
            echo "删除node_modules"
            sudo rm -rf node_modules
            cd ..
        - name: Upload server Build Artifact
          uses: actions/upload-artifact@v2.2.2
          with:
            name: Mix-Space_Server
            path: ./server

    build-kami:
        name: Build Mix-Space(kami)
        runs-on: ubuntu-latest
        steps:
        - name: checkout
          uses: actions/checkout@v2
        - name: Setup Node.js environment
          uses: actions/setup-node@v2.1.4
        - name: Build kami
          run: |
            git clone https://github.com/mx-space/kami
            sudo npm install rimraf -g
            cd kami
            sudo yarn
            sudo  rm -rf .env
            sudo  rm -rf config.ts
            sudo mv ../kami_config/.env .env
            sudo mv ../kami_config/configs.ts configs.ts
            sudo mv ../kami_config/manifest.json manifest.json
            cd public
            sudo rm -rf manifest.json
            sudo mv ../manifest.json manifest.json
            cd ..
            echo "成功填入用户文件"
            sudo yarn build
            echo "删除node_modules"
            sudo rm -rf node_modules
        - name: Upload kami Build Artifact
          uses: actions/upload-artifact@v2.2.2
          with:
            name: Mix-Space_Kami
            path: ./kami

    build-admin:
        name: Build Mix-Space(admin)
        runs-on: ubuntu-latest
        steps:
        - name: checkout
          uses: actions/checkout@v2
        - name: Setup Node.js environment
          uses: actions/setup-node@v2.1.4
        - name: Build admin
          run: |
            git clone https://github.com/mx-space/admin
            sudo npm install rimraf -g
            cd admin
            sudo yarn
            sudo rm -rf .env
            sudo rm -rf vue.config.js
            sudo mv ../admin_config/.env .env
            sudo mv ../admin_config/vue.config.js vue.config.js
            echo "成功填入用户文件"
            sudo yarn build
            echo "删除node_modules"
            sudo rm -rf node_modules
        - name: Upload admin Build Artifact
          uses: actions/upload-artifact@v2.2.2
          with:
            name: Mix-Space_Admin
            path: ./admin/dist
    build-admin-vue3:
        name: Build Mix-Space(admin-vue3)
        runs-on: ubuntu-latest
        steps:
        - name: checkout
          uses: actions/checkout@v2
        - name: Setup Node.js environment
          uses: actions/setup-node@v2.1.4
        - name: Build admin
          run: |
            git clone https://github.com/mx-space/admin-vue3
            sudo npm install rimraf -g
            cd /home/runner/work/Mix-Space-ACTION/Mix-Space-ACTION/admin-vue3
            sudo yarn
            sudo rm -rf .env.production
            pwd
            echo "export const configs = {title: 'wibus',}" > /home/runner/work/Mix-Space-ACTION/Mix-Space-ACTION/admin-vue3/src/configs.ts
            cat /home/runner/work/Mix-Space-ACTION/Mix-Space-ACTION/admin-vue3/src/configs.ts
            sudo mv ../admin_config/.env.production .env.production
            echo "成功填入用户文件"
            sudo yarn build
            echo "删除node_modules"
            sudo rm -rf node_modules
        - name: Upload admin Build Artifact
          uses: actions/upload-artifact@v2.2.2
          with:
            name: Mix-Space_Admin_Vue3
            path: /home/runner/work/Mix-Space-ACTION/Mix-Space-ACTION/admin-vue3/dist
